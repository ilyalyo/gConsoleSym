{% extends 'base.html.twig' %}
{# @controller AppBundle:Default:main #}
{% block stylesheets %}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.12/b-1.2.2/b-colvis-1.2.2/b-flash-1.2.2/b-html5-1.2.2/b-print-1.2.2/fc-3.2.2/fh-3.1.2/r-2.1.0/datatables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.24/daterangepicker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.1/bootstrap3-editable/css/bootstrap-editable.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/featherlight/1.5.0/featherlight.gallery.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/css/bootstrap-slider.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css">
{% endblock %}
    {% block head_javascripts %}
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment-with-locales.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="https://cdn.datatables.net/v/bs/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.12/b-1.2.2/b-colvis-1.2.2/b-flash-1.2.2/b-html5-1.2.2/b-print-1.2.2/fc-3.2.2/fh-3.1.2/r-2.1.0/datatables.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.24/daterangepicker.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.1/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/featherlight/1.5.0/featherlight.gallery.min.js"></script>
        <script src="https://raw.githubusercontent.com/bartaz/sandbox.js/master/jquery.highlight.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/bootstrap-slider.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.min.js"></script>
        <script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
        <script src="{{ path('fos_js_routing_js', {'callback': 'fos.Router.setData'}) }}"></script>

        <!-- Google charts -->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    {% endblock %}
{% block body %}
<div class="container">
    <div class="row">
    <h1>Main</h1>
        {% if is_granted('ROLE_APPROVED') %}
            <ul class="nav nav-tabs">
                {% for c in clients %}
                    {% set active = "" %}
                    {% if client and client.id == c.id %}
                        {% set active = "class=active" %}
                    {% endif %}

                    <li role="presentation" {{ active }}>
                        <a href="{{ path('main', {'client_id': c.id }) }}">
                            <img src="{{ c.picture }}" class="img-circle" width="20" height="20">
                            {{ c.email }}</a>
                    </li>
                {% endfor %}
                {% if authUrl %}
                    <li role="presentation">
                        <a href="{{ authUrl }}">
                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                            Connect google account</a></li>
                {% endif %}
            </ul>
            {% if form %}
                {{ form_start(form) }}
                <div class="container">
                    <div class="row">
                        <div class="col-offset col-md-4">
                            {{ form_label(form.websites) }}
                            <div class="input-group">
                                {{ form_widget(form.websites) }}
                                <span class="input-group-btn">
                                    <input type="submit" value="submit" class="btn"></span>
                            </div>
                        </div>
                    </div>
                </div>
                {{ form_rest(form) }}
                {{ form_end(form) }}
            {% endif %}

            {% if datatable %}
                <div class="container">
                    <div class="row">
                        <div id="chart_div"></div>
                    </div>
                    <div class="row">
                        {{ datatable_render(datatable) }}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <p>You a not approved by admin yet.</p>
        {% endif %}
    </div>
</div>
    <style>
        form{
            padding-top: 20px;
        }
        #chart_div{
            padding-top: 20px;
            display: table;
            margin: 0 auto;
        }
    </style>
    <script type="text/javascript">
        // Load the Visualization API and the corechart package.
        google.charts.load('current', {'packages':['line', 'corechart']});
        google.charts.setOnLoadCallback(subscribeToTableUpdates);

        function subscribeToTableUpdates() {
            updateGraph();
            $('#record_datatable').on('search.dt', function () {
                updateGraph()
            });

            function updateGraph() {
                var website_id = $('#form_websites').val();
                var oTable = $('#record_datatable').dataTable();
                var params = oTable.oApi._fnAjaxParameters(oTable.dataTable().fnSettings());
                $.post(Routing.generate('record_results', { 'id' : website_id})
                        + "?graph=1&" + $.param(params),
                        function(response){
                            drawChart(response);
                        });
            }
        }

        function drawChart(chart_data) {
            // Create the data table.
            var data = new google.visualization.DataTable(chart_data);

            var materialOptions = {
                width: 900,
                height: 400,
                series: {
                    // Gives each series an axis name that matches the Y-axis below.
                    0: {axis: 'Temps'},
                    1: {axis: 'Daylight'}
                },
                axes: {
                    // Adds labels to each axis; they don't have to match the axis names.
                }
            };

            var materialChart = new google.charts.Line(document.getElementById('chart_div'));
            materialChart.draw(data, materialOptions);
        }
    </script>
{% endblock %}
